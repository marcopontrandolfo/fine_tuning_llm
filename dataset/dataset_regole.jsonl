{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Ricavo giornaliero nel Q4 1997 con cumulato e media mobile a 3 giorni."},{"role":"assistant","content":"WITH daily AS ( SELECT DATE(so.orderDate) AS day, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS rev FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId WHERE so.orderDate >= '1997-10-01' AND so.orderDate <= '1997-12-31' GROUP BY DATE(so.orderDate) ) SELECT d.day, d.rev, SUM(d.rev) OVER (ORDER BY d.day) AS cum_rev, AVG(d.rev) OVER (ORDER BY d.day ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS ma3 FROM daily d ORDER BY d.day;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Ricavo mensile per categoria nel 1997 con cumulato per categoria e quota annuale entro categoria."},{"role":"assistant","content":"WITH cat_month AS ( SELECT DATE_FORMAT(so.orderDate,'%Y-%m') AS ym, c.categoryId, c.categoryName, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS rev FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId JOIN Product p ON p.productId = od.productId JOIN Category c ON c.categoryId = p.categoryId WHERE YEAR(so.orderDate) = 1997 GROUP BY DATE_FORMAT(so.orderDate,'%Y-%m'), c.categoryId, c.categoryName ) SELECT cm.ym, cm.categoryId, cm.categoryName, cm.rev, SUM(cm.rev) OVER (PARTITION BY cm.categoryId ORDER BY cm.ym) AS cum_rev_cat, ROUND(100 * cm.rev / NULLIF(SUM(cm.rev) OVER (PARTITION BY cm.categoryId), 0), 2) AS pct_year_cat FROM cat_month cm ORDER BY cm.categoryId, cm.ym;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Media mobile a 7 giorni del ritardo medio per corriere nel 1997 (per corriere)."},{"role":"assistant","content":"WITH ship_days AS ( SELECT s.shipperId, s.companyName, DATE(so.orderDate) AS day, AVG(DATEDIFF(so.shippedDate, so.requiredDate)) AS avg_delay FROM SalesOrder so JOIN Shipper s ON s.shipperId = so.shipperid WHERE YEAR(so.orderDate) = 1997 AND so.shippedDate IS NOT NULL GROUP BY s.shipperId, s.companyName, DATE(so.orderDate) ) SELECT sd.shipperId, sd.companyName, sd.day, sd.avg_delay, AVG(sd.avg_delay) OVER (PARTITION BY sd.shipperId ORDER BY sd.day ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS ma7_delay FROM ship_days sd ORDER BY sd.companyName, sd.day;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Volatilità del ricavo giornaliero nel 1997 come STDDEV_POP su finestra mobile 7 giorni."},{"role":"assistant","content":"WITH daily AS ( SELECT DATE(so.orderDate) AS day, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS rev FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId WHERE YEAR(so.orderDate) = 1997 GROUP BY DATE(so.orderDate) ) SELECT d.day, d.rev, STDDEV_POP(d.rev) OVER (ORDER BY d.day ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS vol7 FROM daily d ORDER BY d.day;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'."},{"role":"user","content":"Per ogni cliente, cumulato ordini mensili e media mobile a 3 mesi del ricavo nel 1997."},{"role":"assistant","content":"WITH cust_month AS ( SELECT DATE_FORMAT(so.orderDate,'%Y-%m') AS ym, so.custId, COUNT(DISTINCT so.orderId) AS orders, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId WHERE YEAR(so.orderDate) = 1997 GROUP BY DATE_FORMAT(so.orderDate,'%Y-%m'), so.custId ) SELECT cm.ym, cm.custId, cm.orders, cm.revenue, SUM(cm.orders) OVER (PARTITION BY cm.custId ORDER BY cm.ym) AS cum_orders, AVG(cm.revenue) OVER (PARTITION BY cm.custId ORDER BY cm.ym ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS ma3_rev FROM cust_month cm ORDER BY cm.custId, cm.ym;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.\n\nRegole (obbligatorie):\n- Produci SOLO la query SQL finale, senza spiegazioni, senza markdown, senza backticks.\n- Dialetto: MySQL 8. Usa esclusivamente istruzioni SELECT (read-only), un solo statement (WITH/CTE consentite), termina con ';'.\n- Evita ambiguità 1052: qualifica SEMPRE le colonne quando più tabelle/CTE le condividono.\n- Formula del ricavo: quantity*unitPrice*(1-COALESCE(discount,0)).\n- ONLY_FULL_GROUP_BY; alias obbligatori per derivate; proteggi divisioni con NULLIF/CASE.\n- Evita feature non supportate (QUALIFY, PERCENTILE_CONT/DISC, FULL OUTER JOIN, OFFSET/FETCH)."},{"role":"user","content":"Ricavo totale e ordini per cliente nel 1997 qualificando tutte le colonne condivise tra tabelle."},{"role":"assistant","content":"SELECT cu.custId, cu.companyName, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue, COUNT(DISTINCT so.orderId) AS orders FROM Customer cu JOIN SalesOrder so ON so.custId = cu.custId JOIN OrderDetail od ON od.orderId = so.orderId WHERE YEAR(so.orderDate) = 1997 GROUP BY cu.custId, cu.companyName ORDER BY revenue DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'."},{"role":"assistant","content":"SELECT c.categoryId, c.categoryName, s.supplierId, s.companyName, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM Category c JOIN Product p ON p.categoryId = c.categoryId JOIN Supplier s ON s.supplierId = p.supplierId JOIN OrderDetail od ON od.productId = p.productId JOIN SalesOrder so ON so.orderId = od.orderId WHERE YEAR(so.orderDate) = 1997 GROUP BY c.categoryId, c.categoryName, s.supplierId, s.companyName ORDER BY c.categoryId, revenue DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Per ogni corriere, ritardo medio e numero ordini per area (shipRegion/shipCountry) nel 1997 (colonne qualificate)."},{"role":"assistant","content":"SELECT s.shipperId, s.companyName, COALESCE(so.shipRegion, so.shipCountry) AS loc, AVG(DATEDIFF(so.shippedDate, so.requiredDate)) AS avg_delay, COUNT(DISTINCT so.orderId) AS orders FROM Shipper s JOIN SalesOrder so ON so.shipperid = s.shipperId WHERE YEAR(so.orderDate) = 1997 AND so.shippedDate IS NOT NULL GROUP BY s.shipperId, s.companyName, COALESCE(so.shipRegion, so.shipCountry) ORDER BY s.shipperId, avg_delay DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Top 5 prodotti per ricavo per regione nel 1997 (qualifica tutte le colonne comuni)."},{"role":"assistant","content":"WITH prod_loc AS ( SELECT p.productId, p.productName, COALESCE(so.shipRegion, so.shipCountry) AS loc, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM Product p JOIN OrderDetail od ON od.productId = p.productId JOIN SalesOrder so ON so.orderId = od.orderId WHERE YEAR(so.orderDate) = 1997 GROUP BY p.productId, p.productName, COALESCE(so.shipRegion, so.shipCountry) ) SELECT pl.productId, pl.productName, pl.loc, pl.revenue FROM prod_loc pl ORDER BY pl.revenue DESC LIMIT 5;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Quota di ricavo per categoria e città nel 1997 (qualifica colonne e usa NULLIF per divisioni)."},{"role":"assistant","content":"WITH cat_city AS ( SELECT c.categoryId, c.categoryName, so.shipCity, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM Category c JOIN Product p ON p.categoryId = c.categoryId JOIN OrderDetail od ON od.productId = p.productId JOIN SalesOrder so ON so.orderId = od.orderId WHERE YEAR(so.orderDate) = 1997 GROUP BY c.categoryId, c.categoryName, so.shipCity ), shares AS ( SELECT categoryId, categoryName, shipCity, revenue, revenue / NULLIF(SUM(revenue) OVER (PARTITION BY categoryId), 0) AS share FROM cat_city ) SELECT shares.categoryId, shares.categoryName, shares.shipCity, ROUND(100 * shares.share, 2) AS pct_share FROM shares ORDER BY shares.categoryId, pct_share DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'."},{"role":"user","content":"Per ogni categoria, mostra il prodotto top per ricavo nel 1997 (evitando QUALIFY)."},{"role":"assistant","content":"WITH prod_cat AS ( SELECT c.categoryId, c.categoryName, p.productId, p.productName, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM Category c JOIN Product p ON p.categoryId = c.categoryId JOIN OrderDetail od ON od.productId = p.productId JOIN SalesOrder so ON so.orderId = od.orderId WHERE YEAR(so.orderDate) = 1997 GROUP BY c.categoryId, c.categoryName, p.productId, p.productName ), ranked AS ( SELECT categoryId, categoryName, productId, productName, revenue, ROW_NUMBER() OVER (PARTITION BY categoryId ORDER BY revenue DESC) AS rn FROM prod_cat ) SELECT categoryId, categoryName, productId, productName, revenue FROM ranked WHERE rn = 1 ORDER BY categoryId, revenue DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Ricavo per categoria nel 1996 vs 1997 con full outer simulato (includi categorie presenti in un solo anno)."},{"role":"assistant","content":"WITH y96 AS ( SELECT c.categoryId, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS rev96 FROM Category c JOIN Product p ON p.categoryId = c.categoryId JOIN OrderDetail od ON od.productId = p.productId JOIN SalesOrder so ON so.orderId = od.orderId WHERE YEAR(so.orderDate) = 1996 GROUP BY c.categoryId ), y97 AS ( SELECT c.categoryId, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS rev97 FROM Category c JOIN Product p ON p.categoryId = c.categoryId JOIN OrderDetail od ON od.productId = p.productId JOIN SalesOrder so ON so.orderId = od.orderId WHERE YEAR(so.orderDate) = 1997 GROUP BY c.categoryId ), keys AS ( SELECT categoryId FROM y96 UNION SELECT categoryId FROM y97 ) SELECT k.categoryId, c.categoryName, y97.rev97, y96.rev96, (COALESCE(y97.rev97,0) - COALESCE(y96.rev96,0)) AS delta, CASE WHEN COALESCE(y96.rev96,0) > 0 THEN ROUND(100 * (COALESCE(y97.rev97,0) - y96.rev96) / y96.rev96, 2) ELSE NULL END AS pct FROM keys k LEFT JOIN y97 ON y97.categoryId = k.categoryId LEFT JOIN y96 ON y96.categoryId = k.categoryId JOIN Category c ON c.categoryId = k.categoryId ORDER BY delta DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Seconda pagina (righe 51-100) degli ordini 1997 per ricavo ordine (evita OFFSET/FETCH)."},{"role":"assistant","content":"WITH orders97 AS ( SELECT so.orderId, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId WHERE YEAR(so.orderDate) = 1997 GROUP BY so.orderId ) SELECT orderId, revenue FROM orders97 ORDER BY revenue DESC LIMIT 50 OFFSET 50;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"90° percentile del ritardo di spedizione per area (shipRegion o shipCountry) nel 1997 (senza PERCENTILE_CONT)."},{"role":"assistant","content":"WITH base AS ( SELECT COALESCE(so.shipRegion, so.shipCountry) AS loc, DATEDIFF(so.shippedDate, so.requiredDate) AS delay_days FROM SalesOrder so WHERE YEAR(so.orderDate) = 1997 AND so.shippedDate IS NOT NULL ), ranked AS ( SELECT loc, delay_days, ROW_NUMBER() OVER (PARTITION BY loc ORDER BY delay_days) AS rn, COUNT(*) OVER (PARTITION BY loc) AS cnt FROM base ) SELECT loc, AVG(delay_days) AS p90_delay FROM ranked WHERE rn BETWEEN CEIL(0.9*cnt) AND CEIL(0.9*cnt)+1 GROUP BY loc ORDER BY p90_delay DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'."},{"role":"user","content":"Per ogni cliente, i 2 prodotti top per ricavo nel 1997 (evitare CROSS APPLY)."},{"role":"assistant","content":"WITH cust_prod AS ( SELECT so.custId, p.productId, p.productName, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId JOIN Product p ON p.productId = od.productId WHERE YEAR(so.orderDate) = 1997 GROUP BY so.custId, p.productId, p.productName ), ranked AS ( SELECT custId, productId, productName, revenue, ROW_NUMBER() OVER (PARTITION BY custId ORDER BY revenue DESC) AS rn FROM cust_prod ) SELECT cu.custId, cu.companyName, r.productId, r.productName, r.revenue FROM ranked r JOIN Customer cu ON cu.custId = r.custId WHERE r.rn <= 2 ORDER BY cu.custId, r.revenue DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'."},{"role":"user","content":"Ricavo giornaliero nel Q4 1997 con cumulato, media mobile 7 giorni e flag HIGH_SPIKE (rev > 1.8*ma7). Usa più CTE ma una sola SELECT finale."},{"role":"assistant","content":"WITH daily AS ( SELECT DATE(so.orderDate) AS day, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS rev FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId WHERE so.orderDate >= '1997-10-01' AND so.orderDate <= '1997-12-31' GROUP BY DATE(so.orderDate) ), cum AS ( SELECT d.day, d.rev, SUM(d.rev) OVER (ORDER BY d.day) AS cum_rev FROM daily d ), ma7 AS ( SELECT d.day, AVG(d.rev) OVER (ORDER BY d.day ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS ma7 FROM daily d ), joined AS ( SELECT c.day, c.rev, c.cum_rev, m.ma7, CASE WHEN c.rev > 1.8 * m.ma7 THEN 'HIGH_SPIKE' ELSE NULL END AS spike FROM cum c JOIN ma7 m ON m.day = c.day ) SELECT j.day, j.rev, j.cum_rev, j.ma7, j.spike FROM joined j ORDER BY j.day;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Profilo cliente: ordini totali, ricavo totale, ritardo medio spedizioni e quota % sul totale ricavi, senza limitare l'anno. Usa più CTE e una SELECT finale."},{"role":"assistant","content":"WITH cust_rev AS ( SELECT so.custId, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId GROUP BY so.custId ), cust_orders AS ( SELECT so.custId, COUNT(DISTINCT so.orderId) AS orders FROM SalesOrder so GROUP BY so.custId ), cust_delay AS ( SELECT so.custId, AVG(DATEDIFF(so.shippedDate, so.requiredDate)) AS avg_delay FROM SalesOrder so WHERE so.shippedDate IS NOT NULL GROUP BY so.custId ), tot AS ( SELECT SUM(revenue) AS total_rev FROM cust_rev ) SELECT cu.custId, cu.companyName, co.orders, cr.revenue, cd.avg_delay, ROUND(100 * cr.revenue / NULLIF(t.total_rev,0), 2) AS pct_total FROM Customer cu LEFT JOIN cust_rev cr ON cr.custId = cu.custId LEFT JOIN cust_orders co ON co.custId = cu.custId LEFT JOIN cust_delay cd ON cd.custId = cu.custId JOIN tot t ORDER BY cr.revenue DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Per categoria: top 3 prodotti per quota di ricavo, con ricavo prodotto, totale categoria e quota %. Usa CTE multiple e una SELECT finale."},{"role":"assistant","content":"WITH prod_cat AS ( SELECT c.categoryId, c.categoryName, p.productId, p.productName, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS rev FROM Category c JOIN Product p ON p.categoryId = c.categoryId JOIN OrderDetail od ON od.productId = p.productId JOIN SalesOrder so ON so.orderId = od.orderId GROUP BY c.categoryId, c.categoryName, p.productId, p.productName ), totals AS ( SELECT categoryId, SUM(rev) AS tot_rev FROM prod_cat GROUP BY categoryId ), shares AS ( SELECT pc.categoryId, pc.categoryName, pc.productId, pc.productName, pc.rev, pc.rev / NULLIF(t.tot_rev,0) AS share FROM prod_cat pc JOIN totals t ON t.categoryId = pc.categoryId ), ranked AS ( SELECT categoryId, categoryName, productId, productName, rev, share, ROW_NUMBER() OVER (PARTITION BY categoryId ORDER BY share DESC) AS rn FROM shares ) SELECT categoryId, categoryName, productId, productName, rev, ROUND(100*share,2) AS pct_share FROM ranked WHERE rn <= 3 ORDER BY categoryId, pct_share DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Prestazioni spedizione: per corriere, spedizioni totali, % in ritardo, ritardo medio pesato per freight, e rank globale su ritardo medio. Usa CTE multiple e SELECT finale."},{"role":"assistant","content":"WITH base AS ( SELECT s.shipperId, s.companyName, DATEDIFF(so.shippedDate, so.requiredDate) AS delay_days, CASE WHEN DATEDIFF(so.shippedDate, so.requiredDate) > 0 THEN 1 ELSE 0 END AS is_late, so.freight FROM SalesOrder so JOIN Shipper s ON s.shipperId = so.shipperid WHERE so.shippedDate IS NOT NULL ), agg AS ( SELECT shipperId, companyName, COUNT(*) AS shipments, 100 * AVG(is_late) AS pct_late, SUM(delay_days * freight)/NULLIF(SUM(freight),0) AS avg_delay_wt FROM base GROUP BY shipperId, companyName ), ranked AS ( SELECT shipperId, companyName, shipments, pct_late, avg_delay_wt, RANK() OVER (ORDER BY avg_delay_wt DESC) AS rnk FROM agg ) SELECT shipperId, companyName, shipments, pct_late, avg_delay_wt, rnk FROM ranked ORDER BY rnk;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Ricavo YoY per regione con variazione assoluta e %, includendo aree presenti solo in un anno (simula full‑outer con unione chiavi). Usa CTE multiple e SELECT finale."},{"role":"assistant","content":"WITH rev AS ( SELECT YEAR(so.orderDate) AS y, COALESCE(so.shipRegion, so.shipCountry) AS loc, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId GROUP BY YEAR(so.orderDate), COALESCE(so.shipRegion, so.shipCountry) ), y_prev AS ( SELECT y+1 AS y, loc, revenue AS rev_prev FROM rev ), y_curr AS ( SELECT y AS y, loc, revenue AS rev_curr FROM rev ), keys AS ( SELECT y, loc FROM y_curr UNION SELECT y, loc FROM y_prev ), paired AS ( SELECT k.y, k.loc, p.rev_prev, c.rev_curr FROM keys k LEFT JOIN y_prev p ON p.y = k.y AND p.loc = k.loc LEFT JOIN y_curr c ON c.y = k.y AND c.loc = k.loc ) SELECT y AS year, loc, rev_prev, rev_curr, (COALESCE(rev_curr,0) - COALESCE(rev_prev,0)) AS delta, CASE WHEN COALESCE(rev_prev,0) > 0 THEN ROUND(100 * (COALESCE(rev_curr,0) - rev_prev) / rev_prev, 2) ELSE NULL END AS pct FROM paired ORDER BY year DESC, delta DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'."},{"role":"assistant","content":"SELECT c.categoryId, c.categoryName, SUM(q.rev) AS revenue FROM Category c JOIN ( SELECT p.categoryId AS categoryId, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS rev FROM Product p JOIN OrderDetail od ON od.productId = p.productId JOIN SalesOrder so ON so.orderId = od.orderId WHERE YEAR(so.orderDate) = 1997 GROUP BY p.categoryId ) AS q ON q.categoryId = c.categoryId GROUP BY c.categoryId, c.categoryName ORDER BY revenue DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Top 5 clienti per ricavo 1997 usando una subquery aggregata con alias e join a Customer."},{"role":"assistant","content":"SELECT cu.custId, cu.companyName, agg.revenue FROM Customer cu JOIN ( SELECT so.custId AS custId, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId WHERE YEAR(so.orderDate) = 1997 GROUP BY so.custId ) AS agg ON agg.custId = cu.custId ORDER BY agg.revenue DESC LIMIT 5;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Per ogni corriere, ordini totali e ricavo totale nel 1997, usando due subquery derivate con alias."},{"role":"assistant","content":"SELECT s.shipperId, s.companyName, o.orders, r.revenue FROM Shipper s JOIN ( SELECT so.shipperid AS shipperId, COUNT(DISTINCT so.orderId) AS orders FROM SalesOrder so WHERE YEAR(so.orderDate) = 1997 GROUP BY so.shipperid ) AS o ON o.shipperId = s.shipperId JOIN ( SELECT so.shipperid AS shipperId, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId WHERE YEAR(so.orderDate) = 1997 GROUP BY so.shipperid ) AS r ON r.shipperId = s.shipperId ORDER BY r.revenue DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Quota di ricavo per supplier nel 1997 usando subquery derivata con alias e finestra per totale per supplier."},{"role":"assistant","content":"WITH sup_prod AS ( SELECT s.supplierId, s.companyName, p.productId, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM Supplier s JOIN Product p ON p.supplierId = s.supplierId JOIN OrderDetail od ON od.productId = p.productId JOIN SalesOrder so ON so.orderId = od.orderId WHERE YEAR(so.orderDate) = 1997 GROUP BY s.supplierId, s.companyName, p.productId ), shares AS ( SELECT sp.supplierId, sp.companyName, sp.productId, sp.revenue, sp.revenue / NULLIF(SUM(sp.revenue) OVER (PARTITION BY sp.supplierId), 0) AS share FROM sup_prod sp ) SELECT sh.supplierId, sh.companyName, sh.productId, ROUND(100*sh.share,2) AS pct_share FROM shares sh ORDER BY sh.supplierId, pct_share DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Ricavo per regione nel 1997 con tabella derivata che calcola ricavo per ordine (alias esplicito)."},{"role":"assistant","content":"SELECT COALESCE(so.shipRegion, so.shipCountry) AS loc, SUM(q.rev) AS revenue FROM SalesOrder so JOIN ( SELECT od.orderId AS orderId, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS rev FROM OrderDetail od GROUP BY od.orderId ) AS q ON q.orderId = so.orderId WHERE YEAR(so.orderDate) = 1997 GROUP BY COALESCE(so.shipRegion, so.shipCountry) ORDER BY revenue DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Quota di ricavo per categoria nel 1997 (percentuale sul totale 1997)."},{"role":"assistant","content":"WITH cat AS ( SELECT c.categoryId, c.categoryName, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId JOIN Product p ON p.productId = od.productId JOIN Category c ON c.categoryId = p.categoryId WHERE YEAR(so.orderDate) = 1997 GROUP BY c.categoryId, c.categoryName ), tot AS ( SELECT SUM(revenue) AS total FROM cat ) SELECT cat.categoryId, cat.categoryName, cat.revenue, ROUND(100 * cat.revenue / NULLIF(tot.total, 0), 2) AS pct FROM cat JOIN tot ORDER BY pct DESC;"}]}
{"messages":[{"role":"system","content":"SSei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Ritardo medio pesato per corriere nel 1997 (peso = freight) e quota di spedizioni in ritardo (%)."},{"role":"assistant","content":"WITH base AS ( SELECT s.shipperId, s.companyName, DATEDIFF(so.shippedDate, so.requiredDate) AS delay_days, CASE WHEN DATEDIFF(so.shippedDate, so.requiredDate) > 0 THEN 1 ELSE 0 END AS is_late, so.freight FROM SalesOrder so JOIN Shipper s ON s.shipperId = so.shipperid WHERE YEAR(so.orderDate) = 1997 AND so.shippedDate IS NOT NULL ), agg AS ( SELECT shipperId, companyName, COUNT(*) AS shipments, 100 * AVG(is_late) AS pct_late, SUM(delay_days * freight) / NULLIF(SUM(freight), 0) AS avg_delay_wt FROM base GROUP BY shipperId, companyName ) SELECT companyName, shipments, pct_late, avg_delay_wt FROM agg ORDER BY avg_delay_wt DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Quota di ricavo per prodotto all'interno della categoria nel 1997 (percentuale sul totale categoria)."},{"role":"assistant","content":"WITH prod AS ( SELECT c.categoryId, c.categoryName, p.productId, p.productName, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId JOIN Product p ON p.productId = od.productId JOIN Category c ON c.categoryId = p.categoryId WHERE YEAR(so.orderDate) = 1997 GROUP BY c.categoryId, c.categoryName, p.productId, p.productName ), shares AS ( SELECT categoryId, categoryName, productId, productName, revenue, revenue / NULLIF(SUM(revenue) OVER (PARTITION BY categoryId), 0) AS share FROM prod ) SELECT categoryId, categoryName, productId, productName, ROUND(100 * share, 2) AS pct_share FROM shares ORDER BY categoryId, pct_share DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Rapporto ordini per cliente 1997/1996 (YoY), con percentuale di crescita e filtro su clienti con almeno 10 ordini nel 1997."},{"role":"assistant","content":"WITH base AS ( SELECT so.custId, YEAR(so.orderDate) AS y, COUNT(DISTINCT so.orderId) AS orders FROM SalesOrder so WHERE YEAR(so.orderDate) IN (1996,1997) GROUP BY so.custId, YEAR(so.orderDate) ), y96 AS ( SELECT custId, orders AS o96 FROM base WHERE y = 1996 ), y97 AS ( SELECT custId, orders AS o97 FROM base WHERE y = 1997 ) SELECT cu.custId, cu.companyName, y97.o97 AS orders_1997, y96.o96 AS orders_1996, (y97.o97 - y96.o96) AS abs_growth, CASE WHEN y96.o96 > 0 THEN ROUND(100 * (y97.o97 - y96.o96) / y96.o96, 2) ELSE NULL END AS pct_growth FROM y97 LEFT JOIN y96 ON y96.custId = y97.custId JOIN Customer cu ON cu.custId = y97.custId WHERE y97.o97 >= 10 ORDER BY pct_growth DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Media mobile a 7 giorni del ricavo giornaliero nel Q4 1997 e percentuale del giorno sul cumulato fino a quel giorno."},{"role":"assistant","content":"WITH daily AS ( SELECT DATE(so.orderDate) AS day, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS rev FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId WHERE so.orderDate >= '1997-10-01' AND so.orderDate <= '1997-12-31' GROUP BY DATE(so.orderDate) ) SELECT d.day, d.rev, SUM(d.rev) OVER (ORDER BY d.day) AS cum_rev, AVG(d.rev) OVER (ORDER BY d.day ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS ma7, ROUND(100 * d.rev / NULLIF(SUM(d.rev) OVER (ORDER BY d.day), 0), 2) AS pct_of_cum FROM daily d ORDER BY d.day;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Delta YoY del ricavo per regione tra anni consecutivi (tutti gli anni disponibili)."},{"role":"assistant","content":"WITH rev AS ( SELECT YEAR(so.orderDate) AS y, r.regionId, r.regiondescription, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId JOIN Employee e ON e.employeeId = so.employeeId JOIN EmployeeTerritory et ON et.employeeId = e.employeeId JOIN Territory t ON t.territoryId = et.territoryId JOIN Region r ON r.regionId = t.regionId GROUP BY YEAR(so.orderDate), r.regionId, r.regiondescription ), paired AS ( SELECT r2.regionId, r2.regiondescription, r2.y AS year, r1.revenue AS rev_prev, r2.revenue AS rev_curr FROM rev r2 JOIN rev r1 ON r1.regionId = r2.regionId AND r1.y = r2.y - 1 ) SELECT regionId, regiondescription, year, rev_prev, rev_curr, (rev_curr - rev_prev) AS delta, CASE WHEN rev_prev > 0 THEN ROUND(100*(rev_curr - rev_prev)/rev_prev,2) ELSE NULL END AS pct FROM paired ORDER BY year DESC, delta DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Ranking per regione dei corrieri per ritardo medio (tutti gli anni)."},{"role":"assistant","content":"WITH base AS ( SELECT r.regionId, r.regiondescription, s.shipperId, s.companyName, DATEDIFF(so.shippedDate, so.requiredDate) AS delay_days FROM SalesOrder so JOIN Shipper s ON s.shipperId = so.shipperid JOIN Employee e ON e.employeeId = so.employeeId JOIN EmployeeTerritory et ON et.employeeId = e.employeeId JOIN Territory t ON t.territoryId = et.territoryId JOIN Region r ON r.regionId = t.regionId WHERE so.shippedDate IS NOT NULL ), agg AS ( SELECT regionId, regiondescription, shipperId, companyName, AVG(delay_days) AS avg_delay FROM base GROUP BY regionId, regiondescription, shipperId, companyName ) SELECT regionId, regiondescription, shipperId, companyName, avg_delay, RANK() OVER (PARTITION BY regionId ORDER BY avg_delay DESC) AS rnk FROM agg ORDER BY regionId, rnk;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Quota di ricavo per categoria all'interno di ciascuna regione (tutti gli anni)."},{"role":"assistant","content":"WITH cat_reg AS ( SELECT r.regionId, r.regiondescription, c.categoryId, c.categoryName, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId JOIN Product p ON p.productId = od.productId JOIN Category c ON c.categoryId = p.categoryId JOIN Employee e ON e.employeeId = so.employeeId JOIN EmployeeTerritory et ON et.employeeId = e.employeeId JOIN Territory t ON t.territoryId = et.territoryId JOIN Region r ON r.regionId = t.regionId GROUP BY r.regionId, r.regiondescription, c.categoryId, c.categoryName ), shares AS ( SELECT regionId, regiondescription, categoryId, categoryName, revenue, revenue / NULLIF(SUM(revenue) OVER (PARTITION BY regionId), 0) AS share FROM cat_reg ) SELECT regionId, regiondescription, categoryId, categoryName, ROUND(100*share,2) AS pct_share FROM shares ORDER BY regionId, pct_share DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Ricavo YoY per regione con confronto tra corrieri (tutti gli anni)."},{"role":"assistant","content":"WITH rev AS ( SELECT YEAR(so.orderDate) AS y, r.regionId, r.regiondescription, s.shipperId, s.companyName, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId JOIN Shipper s ON s.shipperId = so.shipperid JOIN Employee e ON e.employeeId = so.employeeId JOIN EmployeeTerritory et ON et.employeeId = e.employeeId JOIN Territory t ON t.territoryId = et.territoryId JOIN Region r ON r.regionId = t.regionId GROUP BY YEAR(so.orderDate), r.regionId, r.regiondescription, s.shipperId, s.companyName ), paired AS ( SELECT r2.regionId, r2.regiondescription, r2.companyName, r2.y AS year, r1.revenue AS rev_prev, r2.revenue AS rev_curr FROM rev r2 JOIN rev r1 ON r1.regionId = r2.regionId AND r1.companyName = r2.companyName AND r1.y = r2.y - 1 ) SELECT regionId, regiondescription, companyName, year, rev_prev, rev_curr, (rev_curr - rev_prev) AS delta, CASE WHEN rev_prev > 0 THEN ROUND(100*(rev_curr - rev_prev)/rev_prev,2) ELSE NULL END AS pct FROM paired ORDER BY year DESC, delta DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Per regione, top 2 prodotti per quota di ricavo (percentuale sul totale regione), tutti gli anni."},{"role":"assistant","content":"WITH prod_reg AS ( SELECT r.regionId, r.regiondescription, p.productId, p.productName, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId JOIN Product p ON p.productId = od.productId JOIN Employee e ON e.employeeId = so.employeeId JOIN EmployeeTerritory et ON et.employeeId = e.employeeId JOIN Territory t ON t.territoryId = et.territoryId JOIN Region r ON r.regionId = t.regionId GROUP BY r.regionId, r.regiondescription, p.productId, p.productName ), shares AS ( SELECT regionId, regiondescription, productId, productName, revenue, revenue / NULLIF(SUM(revenue) OVER (PARTITION BY regionId), 0) AS share FROM prod_reg ), ranked AS ( SELECT regionId, regiondescription, productId, productName, share, ROW_NUMBER() OVER (PARTITION BY regionId ORDER BY share DESC) AS rn FROM shares ) SELECT regionId, regiondescription, productId, productName, ROUND(100*share,2) AS pct_share FROM ranked WHERE rn <= 2 ORDER BY regionId, pct_share DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Mediana del valore ordine per cliente nel 1997, ordinata decrescente."},{"role":"assistant","content":"WITH ords AS ( SELECT so.custId, od.orderId, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId WHERE YEAR(so.orderDate) = 1997 GROUP BY so.custId, od.orderId ), ranked AS ( SELECT custId, revenue, ROW_NUMBER() OVER (PARTITION BY custId ORDER BY revenue) AS rn, COUNT(*) OVER (PARTITION BY custId) AS cnt FROM ords ) SELECT cu.custId, cu.companyName, AVG(revenue) AS median_rev FROM ranked r JOIN Customer cu ON cu.custId = r.custId WHERE r.rn IN (FLOOR((r.cnt+1)/2), CEIL((r.cnt+1)/2)) GROUP BY cu.custId, cu.companyName ORDER BY median_rev DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"p75 del ritardo di spedizione per corriere nel 1997 (min 20 spedizioni)."},{"role":"assistant","content":"WITH base AS ( SELECT s.shipperId, s.companyName, DATEDIFF(so.shippedDate, so.requiredDate) AS delay_days FROM SalesOrder so JOIN Shipper s ON s.shipperId = so.shipperid WHERE YEAR(so.orderDate) = 1997 AND so.shippedDate IS NOT NULL ), ranked AS ( SELECT shipperId, companyName, delay_days, ROW_NUMBER() OVER (PARTITION BY shipperId ORDER BY delay_days) AS rn, COUNT(*) OVER (PARTITION BY shipperId) AS cnt FROM base ) SELECT companyName, AVG(delay_days) AS p75_delay FROM ranked WHERE rn BETWEEN CEIL(0.75*cnt) AND CEIL(0.75*cnt)+1 GROUP BY companyName HAVING COUNT(*) >= 20 ORDER BY p75_delay DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"p90 del ricavo ordine per categoria nel 1997 (per ordine)."},{"role":"assistant","content":"WITH ords AS ( SELECT c.categoryId, c.categoryName, od.orderId, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM Category c JOIN Product p ON p.categoryId = c.categoryId JOIN OrderDetail od ON od.productId = p.productId JOIN SalesOrder so ON so.orderId = od.orderId WHERE YEAR(so.orderDate) = 1997 GROUP BY c.categoryId, c.categoryName, od.orderId ), ranked AS ( SELECT categoryId, categoryName, revenue, ROW_NUMBER() OVER (PARTITION BY categoryId ORDER BY revenue) AS rn, COUNT(*) OVER (PARTITION BY categoryId) AS cnt FROM ords ) SELECT categoryId, categoryName, AVG(revenue) AS p90_revenue FROM ranked WHERE rn BETWEEN CEIL(0.9*cnt) AND CEIL(0.9*cnt)+1 GROUP BY categoryId, categoryName ORDER BY p90_revenue DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Mediana del ritardo per area (shipRegion o shipCountry) nel 1997."},{"role":"assistant","content":"WITH base AS ( SELECT COALESCE(so.shipRegion, so.shipCountry) AS loc, DATEDIFF(so.shippedDate, so.requiredDate) AS delay_days FROM SalesOrder so WHERE YEAR(so.orderDate) = 1997 AND so.shippedDate IS NOT NULL ), ranked AS ( SELECT loc, delay_days, ROW_NUMBER() OVER (PARTITION BY loc ORDER BY delay_days) AS rn, COUNT(*) OVER (PARTITION BY loc) AS cnt FROM base ) SELECT loc, AVG(delay_days) AS median_delay FROM ranked WHERE rn IN (FLOOR((cnt+1)/2), CEIL((cnt+1)/2)) GROUP BY loc ORDER BY median_delay DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"p50/p75/p90 del ricavo per cliente nel 1997 (per ordine), con tutti e tre i valori."},{"role":"assistant","content":"WITH ords AS ( SELECT so.custId, od.orderId, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId WHERE YEAR(so.orderDate) = 1997 GROUP BY so.custId, od.orderId ), ranked AS ( SELECT custId, revenue, ROW_NUMBER() OVER (PARTITION BY custId ORDER BY revenue) AS rn, COUNT(*) OVER (PARTITION BY custId) AS cnt FROM ords ), pcts AS ( SELECT custId, AVG(CASE WHEN rn IN (FLOOR((cnt+1)/2), CEIL((cnt+1)/2)) THEN revenue END) AS p50, AVG(CASE WHEN rn BETWEEN CEIL(0.75*cnt) AND CEIL(0.75*cnt)+1 THEN revenue END) AS p75, AVG(CASE WHEN rn BETWEEN CEIL(0.9*cnt) AND CEIL(0.9*cnt)+1 THEN revenue END) AS p90 FROM ranked GROUP BY custId ) SELECT cu.custId, cu.companyName, p.p50, p.p75, p.p90 FROM pcts p JOIN Customer cu ON cu.custId = p.custId ORDER BY p.p90 DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Ricavo e numero ordini per categoria e mese nel 1997 (YYYY-MM), rispettando ONLY_FULL_GROUP_BY."},{"role":"assistant","content":"SELECT DATE_FORMAT(so.orderDate,'%Y-%m') AS ym, c.categoryId, c.categoryName, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue, COUNT(DISTINCT so.orderId) AS orders FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId JOIN Product p ON p.productId = od.productId JOIN Category c ON c.categoryId = p.categoryId WHERE YEAR(so.orderDate) = 1997 GROUP BY DATE_FORMAT(so.orderDate,'%Y-%m'), c.categoryId, c.categoryName ORDER BY ym, c.categoryId;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Top 3 città per ricavo per categoria nel 1997 (aggregazione per categoria, città)."},{"role":"assistant","content":"WITH cat_city AS ( SELECT c.categoryId, c.categoryName, so.shipCity, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId JOIN Product p ON p.productId = od.productId JOIN Category c ON c.categoryId = p.categoryId WHERE YEAR(so.orderDate) = 1997 GROUP BY c.categoryId, c.categoryName, so.shipCity ), ranked AS ( SELECT categoryId, categoryName, shipCity, revenue, ROW_NUMBER() OVER (PARTITION BY categoryId ORDER BY revenue DESC) AS rn FROM cat_city ) SELECT categoryId, categoryName, shipCity, revenue FROM ranked WHERE rn <= 3 ORDER BY categoryId, revenue DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Ricavo e ordini per fornitore e paese di spedizione nel 1997."},{"role":"assistant","content":"SELECT s.supplierId, s.companyName, COALESCE(so.shipRegion, so.shipCountry) AS loc, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue, COUNT(DISTINCT so.orderId) AS orders FROM Supplier s JOIN Product p ON p.supplierId = s.supplierId JOIN OrderDetail od ON od.productId = p.productId JOIN SalesOrder so ON so.orderId = od.orderId WHERE YEAR(so.orderDate) = 1997 GROUP BY s.supplierId, s.companyName, COALESCE(so.shipRegion, so.shipCountry) ORDER BY s.supplierId, revenue DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Quota di ricavo per categoria e regione nel 1997 (percentuale entro categoria)."},{"role":"assistant","content":"WITH cat_reg AS ( SELECT c.categoryId, c.categoryName, COALESCE(so.shipRegion, so.shipCountry) AS loc, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId JOIN Product p ON p.productId = od.productId JOIN Category c ON c.categoryId = p.categoryId WHERE YEAR(so.orderDate) = 1997 GROUP BY c.categoryId, c.categoryName, COALESCE(so.shipRegion, so.shipCountry) ), shares AS ( SELECT categoryId, categoryName, loc, revenue, revenue / NULLIF(SUM(revenue) OVER (PARTITION BY categoryId), 0) AS share FROM cat_reg ) SELECT categoryId, categoryName, loc, ROUND(100*share,2) AS pct_share FROM shares ORDER BY categoryId, pct_share DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Ricavo mensile per regione nel 1997, con numero ordini e freight medio per regione e mese."},{"role":"assistant","content":"SELECT DATE_FORMAT(so.orderDate,'%Y-%m') AS ym, COALESCE(so.shipRegion, so.shipCountry) AS loc, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue, COUNT(DISTINCT so.orderId) AS orders, AVG(so.freight) AS avg_freight FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId WHERE YEAR(so.orderDate) = 1997 GROUP BY DATE_FORMAT(so.orderDate,'%Y-%m'), COALESCE(so.shipRegion, so.shipCountry) ORDER BY ym, loc;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Delta giornaliero del ricavo (giorno su giorno) nel Q4 1997 usando LAG."},{"role":"assistant","content":"WITH daily AS ( SELECT DATE(so.orderDate) AS day, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS rev FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId WHERE so.orderDate >= '1997-10-01' AND so.orderDate <= '1997-12-31' GROUP BY DATE(so.orderDate) ) SELECT d.day, d.rev, (d.rev - LAG(d.rev) OVER (ORDER BY d.day)) AS delta_rev FROM daily d ORDER BY d.day;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Top prodotti per ricavo con DENSE_RANK per gestire ex aequo (limita a rank <= 3)."},{"role":"assistant","content":"WITH prod_rev AS ( SELECT p.productId, p.productName, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS revenue FROM Product p JOIN OrderDetail od ON od.productId = p.productId JOIN SalesOrder so ON so.orderId = od.orderId GROUP BY p.productId, p.productName ) SELECT productId, productName, revenue, DENSE_RANK() OVER (ORDER BY revenue DESC) AS rnk FROM prod_rev WHERE DENSE_RANK() OVER (ORDER BY revenue DESC) <= 3 ORDER BY rnk, revenue DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Tempo in giorni tra ordine e spedizione per ogni ordine (TIMESTAMPDIFF), con media per cliente."},{"role":"assistant","content":"WITH ord_delay AS ( SELECT so.orderId, so.custId, TIMESTAMPDIFF(DAY, so.orderDate, so.shippedDate) AS days_to_ship FROM SalesOrder so WHERE so.shippedDate IS NOT NULL ) SELECT cu.custId, cu.companyName, AVG(od.days_to_ship) AS avg_days_to_ship FROM ord_delay od JOIN Customer cu ON cu.custId = od.custId GROUP BY cu.custId, cu.companyName ORDER BY avg_days_to_ship DESC;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Quota di ricavo giornaliera sul cumulato fino a quel giorno senza riusare alias in OVER nella stessa SELECT (usa CTE)."},{"role":"assistant","content":"WITH daily AS ( SELECT DATE(so.orderDate) AS day, SUM(od.quantity*od.unitPrice*(1-COALESCE(od.discount,0))) AS rev FROM SalesOrder so JOIN OrderDetail od ON od.orderId = so.orderId GROUP BY DATE(so.orderDate) ), cum AS ( SELECT d.day, d.rev, SUM(d.rev) OVER (ORDER BY d.day) AS cum_rev FROM daily d ) SELECT c.day, c.rev, c.cum_rev, ROUND(100 * c.rev / NULLIF(c.cum_rev, 0), 2) AS pct_of_cum FROM cum c ORDER BY c.day;"}]}
{"messages":[{"role":"system","content":"Sei un assistente SQL esperto per il database Northwind su MySQL 8.  
Regole: una sola query SELECT, nessuna spiegazione, usa solo tabelle/colonne esistenti, chiudi con ';'.
"},{"role":"user","content":"Evita subquery scalari: calcola per corriere spedizioni totali e ritardo medio (giorni) usando CTE e join, senza subquery scalari nel SELECT."},{"role":"assistant","content":"WITH ship_base AS ( SELECT s.shipperId, s.companyName, DATEDIFF(so.shippedDate, so.requiredDate) AS delay_days FROM SalesOrder so JOIN Shipper s ON s.shipperId = so.shipperid WHERE so.shippedDate IS NOT NULL ), ship_agg AS ( SELECT shipperId, companyName, COUNT(*) AS shipments, AVG(delay_days) AS avg_delay FROM ship_base GROUP BY shipperId, companyName ) SELECT shipperId, companyName, shipments, avg_delay FROM ship_agg ORDER BY avg_delay DESC;"}]}
